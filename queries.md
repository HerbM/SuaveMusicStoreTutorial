## Queries

With the type aliases set up, we can move forward to creating our first queries:

<pre class="fssnip highlighted"><div lang="fsharp"><span class="k">let</span> <span onmouseout="hideTip(event, 'Db.fs:15-34_fs1', 1)" onmouseover="showTip(event, 'Db.fs:15-34_fs1', 1)" class="f">firstOrNone</span> <span onmouseout="hideTip(event, 'Db.fs:15-34_fs2', 2)" onmouseover="showTip(event, 'Db.fs:15-34_fs2', 2)" class="i">s</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'Db.fs:15-34_fs2', 3)" onmouseover="showTip(event, 'Db.fs:15-34_fs2', 3)" class="i">s</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'Db.fs:15-34_fs3', 4)" onmouseover="showTip(event, 'Db.fs:15-34_fs3', 4)" class="t">Seq</span><span class="o">.</span><span onmouseout="hideTip(event, 'Db.fs:15-34_fs4', 5)" onmouseover="showTip(event, 'Db.fs:15-34_fs4', 5)" class="f">tryFind</span> (<span class="k">fun</span> _ <span class="k">-&gt;</span> <span class="k">true</span>)&#10;&#10;<span class="k">let</span> <span onmouseout="hideTip(event, 'Db.fs:15-34_fs5', 6)" onmouseover="showTip(event, 'Db.fs:15-34_fs5', 6)" class="f">getGenres</span> (<span onmouseout="hideTip(event, 'Db.fs:15-34_fs6', 7)" onmouseover="showTip(event, 'Db.fs:15-34_fs6', 7)" class="i">ctx</span> <span class="o">:</span> <span class="i">DbContext</span>) <span class="o">:</span> <span class="i">Genre</span> <span onmouseout="hideTip(event, 'Db.fs:15-34_fs7', 8)" onmouseover="showTip(event, 'Db.fs:15-34_fs7', 8)" class="t">list</span> <span class="o">=</span> &#10;    <span onmouseout="hideTip(event, 'Db.fs:15-34_fs6', 9)" onmouseover="showTip(event, 'Db.fs:15-34_fs6', 9)" class="i">ctx</span><span class="o">.</span><span class="i">``[dbo].[Genres]``</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'Db.fs:15-34_fs3', 10)" onmouseover="showTip(event, 'Db.fs:15-34_fs3', 10)" class="t">Seq</span><span class="o">.</span><span onmouseout="hideTip(event, 'Db.fs:15-34_fs8', 11)" onmouseover="showTip(event, 'Db.fs:15-34_fs8', 11)" class="f">toList</span>&#10;&#10;<span class="k">let</span> <span onmouseout="hideTip(event, 'Db.fs:15-34_fs9', 12)" onmouseover="showTip(event, 'Db.fs:15-34_fs9', 12)" class="f">getAlbumsForGenre</span> <span onmouseout="hideTip(event, 'Db.fs:15-34_fs10', 13)" onmouseover="showTip(event, 'Db.fs:15-34_fs10', 13)" class="i">genreName</span> (<span onmouseout="hideTip(event, 'Db.fs:15-34_fs11', 14)" onmouseover="showTip(event, 'Db.fs:15-34_fs11', 14)" class="i">ctx</span> <span class="o">:</span> <span class="i">DbContext</span>) <span class="o">:</span> <span class="i">Album</span> <span onmouseout="hideTip(event, 'Db.fs:15-34_fs7', 15)" onmouseover="showTip(event, 'Db.fs:15-34_fs7', 15)" class="t">list</span> <span class="o">=</span> &#10;    <span onmouseout="hideTip(event, 'Db.fs:15-34_fs12', 16)" onmouseover="showTip(event, 'Db.fs:15-34_fs12', 16)" class="i">query</span> { &#10;        <span class="k">for</span> <span onmouseout="hideTip(event, 'Db.fs:15-34_fs13', 17)" onmouseover="showTip(event, 'Db.fs:15-34_fs13', 17)" class="i">album</span> <span class="k">in</span> <span onmouseout="hideTip(event, 'Db.fs:15-34_fs11', 18)" onmouseover="showTip(event, 'Db.fs:15-34_fs11', 18)" class="i">ctx</span><span class="o">.</span><span class="i">``[dbo].[Albums]``</span> <span class="k">do</span>&#10;            <span onmouseout="hideTip(event, 'Db.fs:15-34_fs14', 19)" onmouseover="showTip(event, 'Db.fs:15-34_fs14', 19)" class="k">join</span> <span onmouseout="hideTip(event, 'Db.fs:15-34_fs15', 20)" onmouseover="showTip(event, 'Db.fs:15-34_fs15', 20)" class="i">genre</span> <span class="k">in</span> <span onmouseout="hideTip(event, 'Db.fs:15-34_fs11', 21)" onmouseover="showTip(event, 'Db.fs:15-34_fs11', 21)" class="i">ctx</span><span class="o">.</span><span class="i">``[dbo].[Genres]``</span> <span class="i">on</span> (<span class="i">album</span><span class="o">.</span><span class="i">GenreId</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'Db.fs:15-34_fs15', 22)" onmouseover="showTip(event, 'Db.fs:15-34_fs15', 22)" class="i">genre</span><span class="o">.</span><span class="i">GenreId</span>)&#10;            <span onmouseout="hideTip(event, 'Db.fs:15-34_fs16', 23)" onmouseover="showTip(event, 'Db.fs:15-34_fs16', 23)" class="k">where</span> (<span onmouseout="hideTip(event, 'Db.fs:15-34_fs15', 24)" onmouseover="showTip(event, 'Db.fs:15-34_fs15', 24)" class="i">genre</span><span class="o">.</span><span class="i">Name</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'Db.fs:15-34_fs10', 25)" onmouseover="showTip(event, 'Db.fs:15-34_fs10', 25)" class="i">genreName</span>)&#10;            <span onmouseout="hideTip(event, 'Db.fs:15-34_fs17', 26)" onmouseover="showTip(event, 'Db.fs:15-34_fs17', 26)" class="k">select</span> <span onmouseout="hideTip(event, 'Db.fs:15-34_fs13', 27)" onmouseover="showTip(event, 'Db.fs:15-34_fs13', 27)" class="i">album</span>&#10;    }&#10;    <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'Db.fs:15-34_fs3', 28)" onmouseover="showTip(event, 'Db.fs:15-34_fs3', 28)" class="t">Seq</span><span class="o">.</span><span onmouseout="hideTip(event, 'Db.fs:15-34_fs8', 29)" onmouseover="showTip(event, 'Db.fs:15-34_fs8', 29)" class="f">toList</span>&#10;&#10;<span class="k">let</span> <span onmouseout="hideTip(event, 'Db.fs:15-34_fs18', 30)" onmouseover="showTip(event, 'Db.fs:15-34_fs18', 30)" class="f">getAlbumDetails</span> <span onmouseout="hideTip(event, 'Db.fs:15-34_fs19', 31)" onmouseover="showTip(event, 'Db.fs:15-34_fs19', 31)" class="i">id</span> (<span onmouseout="hideTip(event, 'Db.fs:15-34_fs11', 32)" onmouseover="showTip(event, 'Db.fs:15-34_fs11', 32)" class="i">ctx</span> <span class="o">:</span> <span class="i">DbContext</span>) <span class="o">:</span> <span class="i">AlbumDetails</span> <span onmouseout="hideTip(event, 'Db.fs:15-34_fs20', 33)" onmouseover="showTip(event, 'Db.fs:15-34_fs20', 33)" class="t">option</span> <span class="o">=</span> &#10;    <span onmouseout="hideTip(event, 'Db.fs:15-34_fs12', 34)" onmouseover="showTip(event, 'Db.fs:15-34_fs12', 34)" class="i">query</span> { &#10;        <span class="k">for</span> <span onmouseout="hideTip(event, 'Db.fs:15-34_fs13', 35)" onmouseover="showTip(event, 'Db.fs:15-34_fs13', 35)" class="i">album</span> <span class="k">in</span> <span onmouseout="hideTip(event, 'Db.fs:15-34_fs11', 36)" onmouseover="showTip(event, 'Db.fs:15-34_fs11', 36)" class="i">ctx</span><span class="o">.</span><span class="i">``[dbo].[AlbumDetails]``</span> <span class="k">do</span>&#10;            <span onmouseout="hideTip(event, 'Db.fs:15-34_fs16', 37)" onmouseover="showTip(event, 'Db.fs:15-34_fs16', 37)" class="k">where</span> (<span onmouseout="hideTip(event, 'Db.fs:15-34_fs13', 38)" onmouseover="showTip(event, 'Db.fs:15-34_fs13', 38)" class="i">album</span><span class="o">.</span><span class="i">AlbumId</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'Db.fs:15-34_fs19', 39)" onmouseover="showTip(event, 'Db.fs:15-34_fs19', 39)" class="i">id</span>)&#10;            <span onmouseout="hideTip(event, 'Db.fs:15-34_fs17', 40)" onmouseover="showTip(event, 'Db.fs:15-34_fs17', 40)" class="k">select</span> <span onmouseout="hideTip(event, 'Db.fs:15-34_fs13', 41)" onmouseover="showTip(event, 'Db.fs:15-34_fs13', 41)" class="i">album</span>&#10;    } <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'Db.fs:15-34_fs1', 42)" onmouseover="showTip(event, 'Db.fs:15-34_fs1', 42)" class="f">firstOrNone</span>&#10;</div></pre>&#10;<div class="tip" id="Db.fs:15-34_fs1">val firstOrNone : s:seq&lt;&#39;a&gt; -&gt; &#39;a option<br /><br />Full name: CDocument.firstOrNone</div>&#10;<div class="tip" id="Db.fs:15-34_fs2">val s : seq&lt;&#39;a&gt;</div>&#10;<div class="tip" id="Db.fs:15-34_fs3">module Seq<br /><br />from Microsoft.FSharp.Collections</div>&#10;<div class="tip" id="Db.fs:15-34_fs4">val tryFind : predicate:(&#39;T -&gt; bool) -&gt; source:seq&lt;&#39;T&gt; -&gt; &#39;T option<br /><br />Full name: Microsoft.FSharp.Collections.Seq.tryFind</div>&#10;<div class="tip" id="Db.fs:15-34_fs5">val getGenres : ctx:&#39;a -&gt; &#39;b list<br /><br />Full name: CDocument.getGenres</div>&#10;<div class="tip" id="Db.fs:15-34_fs6">val ctx : &#39;a</div>&#10;<div class="tip" id="Db.fs:15-34_fs7">type &#39;T list = List&lt;&#39;T&gt;<br /><br />Full name: Microsoft.FSharp.Collections.list&lt;_&gt;</div>&#10;<div class="tip" id="Db.fs:15-34_fs8">val toList : source:seq&lt;&#39;T&gt; -&gt; &#39;T list<br /><br />Full name: Microsoft.FSharp.Collections.Seq.toList</div>&#10;<div class="tip" id="Db.fs:15-34_fs9">val getAlbumsForGenre : genreName:&#39;a -&gt; ctx:&#39;b -&gt; &#39;c list (requires equality)<br /><br />Full name: CDocument.getAlbumsForGenre</div>&#10;<div class="tip" id="Db.fs:15-34_fs10">val genreName : &#39;a (requires equality)</div>&#10;<div class="tip" id="Db.fs:15-34_fs11">val ctx : &#39;b</div>&#10;<div class="tip" id="Db.fs:15-34_fs12">val query : Linq.QueryBuilder<br /><br />Full name: Microsoft.FSharp.Core.ExtraTopLevelOperators.query</div>&#10;<div class="tip" id="Db.fs:15-34_fs13">val album : &#39;c</div>&#10;<div class="tip" id="Db.fs:15-34_fs14">custom operation: join var in collection on (outerKey = innerKey). Note that parentheses are required after &#39;on&#39;<br /><br />Calls Linq.QueryBuilder.Join </div>&#10;<div class="tip" id="Db.fs:15-34_fs15">val genre : obj</div>&#10;<div class="tip" id="Db.fs:15-34_fs16">custom operation: where (bool)<br /><br />Calls Linq.QueryBuilder.Where </div>&#10;<div class="tip" id="Db.fs:15-34_fs17">custom operation: select (&#39;Result)<br /><br />Calls Linq.QueryBuilder.Select </div>&#10;<div class="tip" id="Db.fs:15-34_fs18">val getAlbumDetails : id:&#39;a -&gt; ctx:&#39;b -&gt; &#39;c option (requires equality)<br /><br />Full name: CDocument.getAlbumDetails</div>&#10;<div class="tip" id="Db.fs:15-34_fs19">val id : &#39;a (requires equality)</div>&#10;<div class="tip" id="Db.fs:15-34_fs20">type &#39;T option = Option&lt;&#39;T&gt;<br /><br />Full name: Microsoft.FSharp.Core.option&lt;_&gt;</div>&#10;&#10;

`getGenres` is a function for finding all genres.
The function, as well as all functions we'll define in `Db` module, takes the `DbContext` as a parameter.
The `: Genre list` part is a type annotation, which makes sure the function returns a list of `Genre`s.
Implementation is straight forward:  ```ctx.``[dbo].[Genres]`` ``` queries all genres, so we just need to pipe it to the `Seq.toList`.

`getAlbumsForGenre` takes `genreName` as argument (inferred to be of type string) and returns a list of `Album`s.
It makes use of "query expression" (`query { }`) which is very similar to C# Linq query.
Read [here](https://msdn.microsoft.com/en-us/library/hh225374.aspx) for more info about query expressions.
Inside the query expression, we're performing an inner join of `Albums` and `Genres` with the `GenreId` foreign key, and then we apply a predicate on `genre.Name` to match the input `genreName`.
The result of the query is piped to `Seq.toList`.

`getAlbumDetails` takes `id` as argument (inferred to be of type int) and returns `AlbumDetails option` because there might be no Album with the given id.
Here, the result of the query is piped to the `firstOrNone` function, which takes care to transform the result to `option` type.
`firstOrNone` verifies if a query returned any result.
In case of any result, `firstOrNone` will return `Some x`, otherwise `None`.


---

GitHub commit: [65b87efad69a8a92a622ba2fa3ac182e1e131cb7](https://github.com/theimowski/SuaveMusicStoreTutorial/commit/65b87efad69a8a92a622ba2fa3ac182e1e131cb7)

Files changed:

* Db.fs (modified)
